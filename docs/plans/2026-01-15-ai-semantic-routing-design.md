# AI 语义路由判断系统设计

**设计日期**: 2026-01-15
**设计目标**: 优化多模型路由决策机制，从基于规则的评分算法改为 AI 语义判断

## 背景

当前的多模型路由系统（multi-model-core）使用硬编码的评分算法来决定任务应该路由到 Gemini（前端专家）、Codex（后端专家）还是触发交叉验证。该算法基于：
- 文件扩展名匹配（`.tsx` → Gemini，`.go` → Codex）
- 目录结构模式（`components/` → Gemini，`api/` → Codex）
- 关键词评分（"UI" → Gemini，"API" → Codex）

**问题**：
- 缺乏语义理解能力，只能做机械模式匹配
- 难以处理边缘情况和新技术栈
- 规则维护成本高，需要不断添加新模式
- 无法综合考虑任务的实际本质

## 设计目标

让 Claude 使用其自然语言理解能力，基于任务的语义内容来智能判断路由目标，而不是依赖硬编码规则。

## 核心设计

### 1. 决策方式：Claude 语义分析

**输入信息（标准信息集）**：
- 用户的任务描述（语义内容）
- 涉及的文件路径和文件类型
- 项目技术栈信息（从 package.json、go.mod、requirements.txt 等推断）

**决策过程**：
Claude 分析以上信息，运用对编程领域的理解，判断任务应该路由到：
- **Gemini**：前端任务（UI、组件、样式、交互）
- **Codex**：后端任务（API、数据库、算法、性能）
- **Cross-Validation**：不确定或全栈任务
- **Claude**：简单任务，无需外部模型

**决策框架**：
```markdown
# 路由决策分析框架

## 任务信息
- 任务描述：[用户请求]
- 涉及文件：[文件路径列表]
- 项目技术栈：[推断的技术栈]

## 分析维度
1. **任务本质**：这个任务主要解决什么问题？
2. **技术领域**：偏向前端（UI/交互）还是后端（逻辑/数据）？
3. **复杂度**：是否涉及多个领域或不确定因素？

## 决策输出
- 路由目标：GEMINI | CODEX | CROSS_VALIDATION | CLAUDE
- 简要理由：一句话说明判断依据
```

### 2. 用户体验：简要通知

**通知格式**：
```
我将使用 [模型名] 来 [处理任务类型]
```

**示例**：
- "我将使用 Codex 来分析这个 API 性能问题"
- "我将使用 Gemini 来优化这个组件的样式"
- "我将使用交叉验证来评估这个全栈架构设计"

**原则**：
- 告知用户正在使用哪个模型
- 不详细展示决策推理过程
- 保持简洁，不打断工作流

### 3. 不确定情况处理：倾向交叉验证

当 Claude 分析后发现以下情况时，触发交叉验证：
- 任务同时涉及前端和后端
- 信息不足，难以明确判断技术领域
- 复杂问题，需要多视角分析
- 关键设计决策

**理由**：不确定说明任务复杂度较高，值得投入双模型的资源来获得更全面的分析。

### 4. 决策流程

```
技能需要外部模型
    ↓
收集标准信息集
 - 任务描述
 - 文件路径/类型
 - 技术栈
    ↓
Claude 语义分析
理解任务本质
    ↓
决策判断 ──→ 明确前端 → 通知用户 → 调用 Gemini
    ├──────→ 明确后端 → 通知用户 → 调用 Codex
    ├──────→ 不确定/全栈 → 通知用户 → 交叉验证（并行调用 Codex + Gemini）
    └──────→ 简单任务 → 通知用户 → Claude 直接处理
```

## 技术实现

### 1. 新增文件

**`skills/multi-model-core/routing-decision.md`**：
定义 Claude 进行语义判断时的思考框架，包括：
- 分析维度说明
- 决策输出格式
- 示例场景

### 2. 修改的技能

以下技能需要更新其调用 multi-model-core 的方式：

| 技能 | 使用场景 |
|------|----------|
| `systematic-debugging` | 根因分析时的交叉诊断 |
| `brainstorming` | 设计方案的多视角评估 |
| `writing-plans` | 技术方案设计时的专业建议 |
| `executing-plans` | 实施阶段的任务路由 |
| `subagent-driven-development` | 子任务的前后端分发 |
| `requesting-code-review` | 双模型交叉审查 |
| `test-driven-development` | 按技术栈路由测试生成 |
| `verification-before-completion` | 验证阶段的交叉确认 |

**修改模式**：
所有技能中原本引用 routing-rules.md 决策逻辑的部分，改为：
1. 引导 Claude 收集标准信息集
2. 参考 routing-decision.md 的分析框架进行语义判断
3. 输出简要通知
4. 执行相应的 codeagent-wrapper 调用

### 3. 保留的文件

**`skills/multi-model-core/routing-rules.md`**：
- 保留作为 Claude 的参考知识
- 帮助理解各个模型的专长领域
- 不再作为强制执行的规则算法

**`skills/multi-model-core/cross-validation.md`**：
- 保留交叉验证的执行指导
- 调用方式不变

### 4. 向后兼容性

- codeagent-wrapper 调用接口保持不变
- 所有外部模型通信仍使用英语
- 现有的提示词模板（codex-base.md、gemini-base.md）继续使用

## 优势分析

### 1. 更灵活
- 能理解新技术栈，无需手动添加规则
- 能处理边缘情况（如混合框架 Next.js）
- 能根据上下文做出细微调整

### 2. 更智能
- 基于任务的实际语义内容而非表面模式
- 能综合考虑多个因素
- 能理解任务的真实意图

### 3. 更简洁
- 减少硬编码规则的维护
- 不需要为每种新场景添加规则
- 决策逻辑更集中、更清晰

### 4. 更透明
- 通过简要通知让用户了解决策
- 决策过程可追溯（如需调试）
- 用户体验更流畅

## 实施计划

### 阶段 1：创建路由决策框架
- [ ] 创建 `skills/multi-model-core/routing-decision.md`
- [ ] 定义分析维度和决策输出格式
- [ ] 添加示例场景说明

### 阶段 2：更新 multi-model-core 主文档
- [ ] 修改 `skills/multi-model-core/SKILL.md`
- [ ] 更新"路由规则"章节，说明新的语义判断方式
- [ ] 保留 routing-rules.md 的引用作为参考知识

### 阶段 3：更新相关技能（共 8 个）
- [ ] systematic-debugging
- [ ] brainstorming
- [ ] writing-plans
- [ ] executing-plans
- [ ] subagent-driven-development
- [ ] requesting-code-review
- [ ] test-driven-development
- [ ] verification-before-completion

每个技能的修改步骤：
1. 识别调用外部模型的位置
2. 替换规则评分逻辑为语义判断引导
3. 添加简要通知输出
4. 验证修改后的工作流

### 阶段 4：文档更新
- [ ] 更新 README.md 和 README-zh.md
- [ ] 说明路由机制的改进
- [ ] 更新架构说明（如有必要）

### 阶段 5：测试验证
- [ ] 测试各种场景的路由决策
- [ ] 验证简要通知的用户体验
- [ ] 确保不确定情况正确触发交叉验证

## 风险和缓解

### 风险 1：决策不稳定
**描述**：AI 判断可能在相似场景下产生不同结果
**缓解**：通过 routing-decision.md 提供明确的分析框架，标准化决策过程

### 风险 2：决策错误
**描述**：Claude 可能将前端任务误判为后端或反之
**缓解**：
- 保留 routing-rules.md 作为参考知识
- 不确定时倾向交叉验证，降低误判风险
- 外部模型无写入权限，Claude 最终审核结果

### 风险 3：性能影响
**描述**：语义分析可能增加决策时间
**缓解**：
- 标准信息集保持精简
- 决策框架清晰，减少思考时间
- 简单任务快速判断，复杂任务才深入分析

## 成功标准

1. **功能完整性**：所有相关技能成功集成新的路由机制
2. **决策准确性**：路由决策符合任务的实际技术领域
3. **用户体验**：简要通知清晰、不干扰工作流
4. **灵活性**：能处理新技术栈和边缘场景
5. **向后兼容**：现有工作流不受破坏

## 总结

这个设计将多模型路由从机械的规则匹配提升为智能的语义理解，充分发挥 Claude 的自然语言处理能力。通过标准信息集和清晰的分析框架，既保证了决策质量，又保持了系统的简洁性。不确定时倾向交叉验证的策略，确保了复杂问题能得到全面分析。整体方案在提升灵活性和智能性的同时，保持了良好的用户体验和向后兼容性。
